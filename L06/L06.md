# Создание чат-бота

## Библиотеки для создания бота
Для создания телеграм-ботов на Python существует несколько десятков библиотек. Они различаются популярностью, размером комьюнити и функциональностью. Рассмотрим самые популярные.

Aiogram. Современная библиотека, набирающая популярность: многие чат-боты написаны на ней. В этой и последующих статьях цикла мы будем работать именно с Aiogram. Библиотека реализует асинхронное выполнение кода, что позволяет не останавливать работу бота в ожидании ответа пользователя. Кроме того, у Aiogram есть подробная документация и большое русскоязычное комьюнити.

Python-telegram-bot. Одна из первых библиотек для создания ботов. Отличается от Aiogram синхронным подходом к работе, то есть при ожидании ответа от пользователя выполнение кода останавливается.

TeleBot. Библиотека для создания простых ботов, позволяющая работать с асинхронным и синхронным подходом на выбор. Подходит для небольших проектов. Подробнее можно узнать в документации.

## Что нужно знать об Aiogram перед написанием кода
Перед тем как приступить к написанию нашего бота, остановимся подробнее на одной технической особенности Aiogram.

Как уже было сказано ранее, одно из главных достоинств библиотеки — полная асинхронность. Она использует синтаксис async/await, который позволяет программе выполнять несколько задач одновременно и эффективно управлять потоком выполнения.

Вот простой пример функции, использующей механизм async/await:
```
@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    await message.answer(f"Hello, {html.bold(message.from_user.full_name)}!")
```

Функция, которая обрабатывает сообщение пользователя в Telegram, называется хендлером, то есть обработчиком. У каждой команды или группы команд свой обработчик.
В хендлере мы прописываем, что бот должен сделать в ответ на сообщение. А для того, чтобы для каждой команды вызывался нужный обработчик, функция оборачивается в декоратор, которому передаётся имя команды без символа /.

Служебное слово async указывает интерпретатору, что функция будет работать в асинхронном режиме. Это означает, что интерпретатору не нужно ждать, пока выполняется код функции, — он может выполнять следующие инструкции, пока start что-нибудь не вернёт. Это «что-нибудь» следует за служебным словом await («ожидать»), а не return, как в обычном коде.

Другой плюс Aiogram — в большом наборе инструментов и хуков, которые можно использовать для добавления дополнительных функций и настроек бота. Библиотека обеспечивает полный доступ ко всем возможностям Telegram API, включая отправку и получение сообщений, управление клавиатурой, обработку медиафайлов (фотографий, видео, документов) и многое другое.

## Создаём эхо-бота
Переходим к созданию телеграм-бота. Потренируемся на простом примере — создадим эхо-бота, который отвечает на сообщения пользователя его же словами.

Для этого нам необходимо:
* установить Python и настроить виртуальное окружение **(если на устройстве, в Google Colab это можно пропустить)**;
* зарегистрировать бота в специальном телеграм-канале @BotFather;
* установить библиотеку Aiogram;
* написать код эхо-бота, связав его по API с Telegram.

### Шаг 1 **(пример для Linux, в Google Colab это можно пропустить)**
Устанавливаем Python
На macOS или Linux. Python установлен в эти операционные системы изначально. Чтобы проверить его наличие, откройте терминал и введите команду:
```
python --version
```

Если Python установлен, то терминал покажет его версию.
На Windows требуется установка Python.

## Шаг 2 **(пример для Linux, в Google Colab это можно пропустить)**
Создаём виртуальное окружение
После установки и проверки Python требуется установить виртуальное окружение с помощью virtualenv. Это специальный инструмент, который позволяет изолировать друг от друга проекты в разработке, независимо устанавливая для них библиотеки и пакеты. Удобно, когда вы работаете над разными приложениями одновременно.

virtualenv устанавливается через терминал:
```
sudo pip3 install virtualenv
```

После этого необходимо создать директорию для проекта, внутри которой будет работать виртуальное окружение:
```
mkdir telegram_bot
cd telegram_bot
```

Команда mkdir создаст папку telegram_bot, а команда cd переведёт нас в неё. Теперь в этой директории будут храниться файлы проекта, связанные с нашим ботом.

Развернём виртуальное окружение внутри папки telegram_bot:
```
virtualenv venv -p python3
```

Теперь его активируем. Если этого не сделать, то оно не будет работать.
```
source venv/bin/activate
```

Виртуальное окружение запущено, и мы готовы перейти к следующему шагу.

### Шаг 3
Создаём бота
Для создания бота необходимо воспользоваться Telegram и ботом @BotFather. Откройте мессенджер и введите название бота в поисковой строке.

Теперь напишем название и юзернейм для нашего бота. Назовём его echo_skillbox_bot (теперь это имя занято, так что вам надо будет придумать своё). В ответ придёт наш токен, который мы будем использовать для подключения к API Telegram.

Этот токен мы сохраняем — он потребуется нам в будущем.

### Шаг 4
Подключаем Aiogram
Для установки Aiogram воспользуемся менеджером пакетов PIP. Вводим в терминал:
```
pip install aiogram
```

Важно! Библиотека устанавливается в созданное ранее виртуальное окружение, связанное с папкой telegram_bot. Если вы решите создать нового бота в другой директории на компьютере, то установку будет необходимо провести заново, иначе Aiogram не будет работать.

### Шаг 5
Пишем код для эхо-бота
Откроем IDE (среду разработки) и создадим файл main.py. Для этого проекта нам потребуется только он. Импортируем из Aiogram нужные классы и модуль:
```
import nest_asyncio # это необходимо для корректной работы синхронизации для Colab
nest_asyncio.apply()

from aiogram import Bot, Dispatcher, html # элементы для работы бота
from aiogram.client.default import DefaultBotProperties # базовые настройки бота
from aiogram.enums import ParseMode # загрузка типов данных для отображения
from aiogram.filters import CommandStart # отдельные компоненты для кнопки старта
from aiogram.types import Message # обработка сообщений
```

Разберёмся, что каждый из них делает. Начнём с классов:

* Bot определяет, на какие команды от пользователя и каким способом отвечать.
* Dispatcher позволяет отслеживать обновления.
* html язык для разметки, но возвращать можно и обычный текст.
Подробно об этом можно прочесть в документации.

Импортируем наш токен, который поможет коммуницировать с API Telegram:
```
TOKEN = 'СЮДА ВПИСАТЬ ТОКЕН'
```

Теперь необходимо инициализировать объекты bot и Dispatcher, передав первому наш токен. Если их не инициализировать, то код не будет работать.
```
bot = Bot(token=API_TOKEN)
dp = Dispatcher(bot)
```

Настроим приветственное окно для нового пользователя, которое будет появляться при нажатии команды /start. Для этого создаём message_handler и прописываем функцию ответа:
```
@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    await message.answer(f"Hello, {html.bold(message.from_user.full_name)}!") # при нажатии старта приветствует пользователя, используя его имя в телеграм
```
Теперь при нажатии на кнопку Начать или при вводе команды /start пользователь будет получать от бота приветственное сообщение.

Теперь создадим событие, которое будет обрабатывать введённое пользователем сообщение:
```
@dp.message_handler() #Создаём новое событие, которое запускается в ответ на любой текст, введённый пользователем.
async def echo(message: types.Message): #Создаём функцию с простой задачей — отправить обратно тот же текст, что ввёл пользователь.
   await message.answer(message.text)
```

Так как бот должен реагировать на любое текстовое сообщение от пользователя, то скобки мы оставляем пустыми. Параметр message не отличается от использованного в предыдущих шагах.

Для ответа мы также используем метод message, указывая, что возвращаем исходный текст, принятый в message.

Остаётся последний этап — настроить получение сообщений от сервера в Telegram. Если этого не сделать, то мы не получим ответы бота. Реализовать получение новых сообщений можно с помощью поллинга. Он работает очень просто — метод start_polling опрашивает сервер, проверяя на нём обновления. Если они есть, то они приходят в Telegram. Для включения поллинга необходимо добавить две строчки:
```
async def main() -> None:
  bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
  await dp.start_polling(bot)

if __name__ == "__main__":
  asyncio.run(main())
```

Всё, теперь код нашего бота полностью готов:
```
import asyncio
import nest_asyncio
nest_asyncio.apply()

from aiogram import Bot, Dispatcher, html
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
from aiogram.filters import CommandStart
from aiogram.types import Message

TOKEN = 'СЮДА ВПИСАТЬ ТОКЕН'

dp = Dispatcher()


@dp.message(CommandStart())
async def command_start_handler(message: Message) -> None:
    await message.answer(f"Hello, {html.bold(message.from_user.full_name)}!")



@dp.message()
async def echo_handler(message: Message) -> None:
  await message.send_copy(chat_id=message.chat.id)


async def main() -> None:
  bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
  await dp.start_polling(bot)

if __name__ == "__main__":
  asyncio.run(main())
```

Сохраняем его в нашей папке telegram_bot под именем main.py.

### Шаг 6 **(пример для Linux, в Google Colab выполняем блоки кода)**
Запускаем бота и проверяем работу
Для запуска бота нам необходим терминал. Открываем его и переходим в нашу папку telegram_bot. После этого вводим команду:
```
python3 main.py
```

Находим нашего бота в Telegram и запускаем его, нажав на кнопку Начать. В ответ на это или на команду /start нам придёт приветственное сообщение.
Попробуем написать что-то.

Как мы видим — всё работает. Бот возвращает нам наши сообщения.

## Что дальше?
Расширять функциональность бота, указывая для разных команд пользователя разные ответы. Например, добавить раздел помощи, который будет появляться по команде /help. Или настроить запуск кода на виртуальном сервере, чтобы бот работал независимо от вашего компьютера.

# Создаём и настраиваем меню

## Виды клавиатур
Библиотека aiogram позволяет создать на Python клавиатуры двух видов, отличающиеся друг от друга расположением кнопок:

* Reply-кнопки для шаблонных ответов, которые закрепляются вместо основной клавиатуры на экране. Часто используются в чат-ботах как меню. Создаются с помощью метода ReplyKeyboardMarkup.
* Инлайн-кнопки, связанные с сообщениями в чате. При этом пользователь видит и основную клавиатуру. Создаются с помощью метода InlineKeyboardMarkup.

## Создание меню
Наш эхо-бот для Telegram сейчас позволяет только отправлять текстовые сообщения и получать их обратно. Давайте проапгрейдим его и добавим кнопки с готовыми сообщениями, которые не надо вводить самому. Это будут reply-кнопки.

Нам понадобится класс ReplyKeyboardMarkup — для начала импортируем его и дополнительные необходимые классы:
```
from aiogram.types import ReplyKeyboardRemove, ReplyKeyboardMarkup, KeyboardButton
```

ReplyKeybordRemove и ReplyKeyboardMarkup позволяют создавать и удалять клавиатуру, а класс KeyboardButton используется для добавления кнопок.

Теперь создадим кнопки с готовыми фразами. Напишем код и разберёмся в нём:

```
@dp.message(CommandStart())
async def send_welcome(message: Message):
  kb = [
       [
           types.KeyboardButton(text="Сможешь повторить это?"),
           types.KeyboardButton(text="А это?")
       ],
   ]
  keyboard = types.ReplyKeyboardMarkup(keyboard=kb)
  await message.reply("Привет!\nЯ Эхобот!\nОтправь мне любое сообщение, а я тебе обязательно отвечу.", reply_markup=keyboard)
```

Сначала создадим в нашем первом декораторе список kb, который будет хранить кнопки. Кнопка в aiogram создаётся с помощью types.KeyboardButton(text=" "), где в параметре text мы передаём отображаемое название кнопки.

После этого необходимо создать клавиатуру и рассказать ей про наши кнопки. Делается это с помощью метода types.ReplyKeyboardMarkup(keyboard=list), где вместо list записывается название списка с кнопками — в нашем случае это список kb.

Теперь остаётся показать клавиатуру в Telegram-чате. Для этого добавляем в ответ строку reply_markup=keyboard, которая отображает клавиатуру после команды /start. Теперь при запуске бота мы видим, что в чате появились обе кнопки из списка kb.

Если нажать на любую кнопку, текст кнопки отправится в чат, а Telegram-бот пришлёт в ответ эту же фразу.

Можно создавать сколько угодно шаблонов, а также связывать кнопку с новыми действиями. Попробуем это на примере инлайн-клавиатур.

## Инлайн-кнопки на aiogram

Инлайн-кнопки отличаются от обычных тем, что связаны не с областью клавиатуры в мессенджере, а с каким-то сообщением в Telegram-чате. Самый простой пример инлайн-кнопки — это меню в канале @BotFather, с помощью которого мы создавали токен для доступа к API Telegram.

Создадим на Python для нашего бота инлайн-кнопки со ссылками. Для этого вернёмся к разделу с импортами в коде и добавим ещё одну строку, чтобы можно было использовать необходимые классы:
```
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import Command
```

InlineKeyboardMarkup пригодится для инициализации инлайн-кнопок, а InlineKeyboardButton — для их создания.

Теперь создадим сами кнопки:
```
urlkb = [
        [
            types.InlineKeyboardButton(text='Список отличников', url='https://www.youtube.com/watch?v=dQw4w9WgXcQ')
        ],
        [
            types.InlineKeyboardButton(text='Хочу получить автомат', url='https://www.youtube.com/watch?v=dQw4w9WgXcQ')
        ]
]
urlkb_all = types.InlineKeyboardMarkup(inline_keyboard=urlkb)

@dp.message(Command("Ссылки"))
async def url_command(message: Message):
   await message.answer('Полезные ссылки:', reply_markup=urlkb_all)
```

Мы инициализируем клавиатуру с помощью InlineKeyboardMarkup, передав в качестве аргумента row_width число 1. Оно определяет, сколько кнопок будет находиться в одном ряду. Так как у нас надписи на кнопках длинные, лучше поместить их друг под другом.

Создаём для каждой кнопки отдельную переменную и инициализируем класс Button. В параметрах указываем:

* text — текст, который будет показан на кнопке в мессенджере;
* url — URL страницы, на которую пользователь будет переходить при нажатии на кнопку.
Делаем это по аналогии с обычными кнопками — с той лишь разницей, что в качестве команды вызова укажем ссылки, а в параметре reply_markup передадим название нашей клавиатуры — urlkb.

Повторно запустим нашего бота и посмотрим на результат.

Добавим в начальное меню кнопку со ссылками:
```
@dp.message(CommandStart())
async def send_welcome(message: Message):
  kb = [
       [
            types.KeyboardButton(text="Сможешь повторить это?"),
            types.KeyboardButton(text="А это?"),
            types.KeyboardButton(text="/Ссылки")
       ],
   ]
  keyboard = types.ReplyKeyboardMarkup(keyboard=kb)
  await message.reply("Привет!\nЯ Эхобот!\nОтправь мне любое сообщение, а я тебе обязательно отвечу.", reply_markup=keyboard)
```

Всё получилось. Теперь инлайн-клавиатура появляется при отправке команды /Cсылки в бот.
